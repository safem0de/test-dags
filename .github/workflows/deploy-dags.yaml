name: Deploy DAGs to Kubernetes

on:
  push:
    branches:
      - main
    paths:
      - "dags/**"  # ทำงานเมื่อมีการเปลี่ยนแปลงในโฟลเดอร์ dags

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: "latest"

    # - name: Authenticate with Kubernetes
    #   run: |
    #     echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > kubeconfig.yaml
    #     export KUBECONFIG=kubeconfig.yaml
    #     kubectl version --client
    #     kubectl cluster-info
    - name: Authenticate with Kubernetes
      run: |
        mkdir -p $HOME/.kube/
        echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
        export KUBECONFIG=$HOME/.kube/config
        # kubectl config use-context $(kubectl config current-context)

    - name: Check Kubernetes Cluster Connection
      run: |
        echo "KUBECONFIG Path: $HOME/.kube/config"
        ls -lah $HOME/.kube/
        cat $HOME/.kube/config || echo "❌ No kubeconfig file found!"


    - name: Get Airflow Pod Name
      run: |
        POD_NAME=$(kubectl get pod -n apache-airflow-test -l app=airflow -o jsonpath="{.items[0].metadata.name}")
        echo "📌 Found Airflow Pod: $POD_NAME"
        echo "POD_NAME=$POD_NAME" >> $GITHUB_ENV

    - name: Ensure DAGs Directory Exists
      run: |
        kubectl exec -n apache-airflow-test $POD_NAME -c airflow-webserver -- mkdir -p /opt/airflow/dags

    - name: Copy DAGs to Kubernetes
      run: |
        echo "📂 Copying DAGs to /opt/airflow/dags in Pod: $POD_NAME"
        kubectl cp dags/. apache-airflow-test/$POD_NAME:/opt/airflow/dags -c airflow-webserver

    - name: Verify DAGs in Kubernetes
      run: |
        echo "✅ Checking DAGs inside Airflow Pod"
        kubectl exec -n apache-airflow-test $POD_NAME -c airflow-webserver -- ls -al /opt/airflow/dags
